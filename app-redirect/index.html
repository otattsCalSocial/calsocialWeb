<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Add Event</title>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Function to extract the event ID from the URL path
        function getEventPath() {
          const path = window.location.pathname; // e.g., "/event/12345"
          // Optionally, you can add validation to ensure the path matches expected patterns
          return path.startsWith("/") ? path : "/" + path;
        }

        const eventPath = getEventPath(); // e.g., "/event/12345"
        const deepLinkBase = "calsocial://";
        const universalLinkBase = "https://cal.social";

        const deepLink = deepLinkBase + eventPath; // e.g., "calsocial://event/12345"
        const universalLink = universalLinkBase + eventPath; // e.g., "https://cal.social/event/12345"

        const appStoreURL = "https://apps.apple.com/app/calsocial/id6738835548";
        const playStoreURL =
          "https://play.google.com/store/apps/details?id=YOUR_PACKAGE_NAME";

        let isAppOpened = false;

        function openApp() {
          const userAgent =
            navigator.userAgent || navigator.vendor || window.opera;
          const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
          const isAndroid = /Android/i.test(userAgent);
          const isChrome = /Chrome/i.test(userAgent);
          const isFirefox = /Firefox/i.test(userAgent);
          const isEdge = /Edg/i.test(userAgent);

          // Set a timeout to redirect if the app was not opened
          const timeout = setTimeout(function () {
            if (!isAppOpened) {
              if (isIOS) {
                window.location.href = appStoreURL;
              } else if (isAndroid) {
                window.location.href = playStoreURL;
              } else {
                window.location.href = universalLink;
              }
            }
          }, 1500);

          // Listen for visibility change
          function handleVisibilityChange() {
            if (document.hidden) {
              isAppOpened = true;
              clearTimeout(timeout);
            }
          }

          document.addEventListener("visibilitychange", handleVisibilityChange);

          if (isIOS || isAndroid) {
            // Attempt to open the app using window.location
            window.location.href = deepLink;

            // For browsers that may not handle window.location well, use a hidden iframe
            const iframe = document.createElement("iframe");
            iframe.style.display = "none";
            iframe.src = deepLink;
            document.body.appendChild(iframe);

            // As an additional fallback, use window.open for browsers like Firefox and Edge
            setTimeout(function () {
              if (!isAppOpened) {
                window.open(deepLink, "_blank");
              }
            }, 1000);
          } else {
            // For unsupported devices or desktop browsers, redirect to the website
            window.location.href = universalLink;
          }
        }

        openApp();
      });
    </script>
  </head>
  <body>
    <p>Opening CalSocial...</p>
  </body>
</html>
